version: '3.8'

services:
  backend:
    image: google-ranker:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: google-ranker-prod
    ports:
      - "5000:5000"
    restart: always
    networks:
      - google-ranker-network-prod
    volumes:
      - backend-logs:/app/logs
      - backend-data:/app/data
    environment:
      # Server Configuration
      - PORT=5000
      - NODE_ENV=production
      
      # Frontend URL (for CORS) - Azure Static Web Apps
      - FRONTEND_URL=https://happy-forest-0fe6bb90f.3.azurestaticapps.net
      
      # Google OAuth Configuration
      - GOOGLE_CLIENT_ID=574451618275-vl5r928f5pj6ogj4le1o75tilhiagmfu.apps.googleusercontent.com
      - GOOGLE_CLIENT_SECRET=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
      - GOOGLE_REDIRECT_URI=https://happy-forest-0fe6bb90f.3.azurestaticapps.net/auth/google/callback
      - HARDCODED_ACCOUNT_ID=114365245834970891636
      
      # Supabase Configuration
      - SUPABASE_URL=https://eyrkxpodgqileiqxblpr.supabase.co
      - SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5cmt4cG9kZ3FpbGVpcXhibHByIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MzA5MDM0NCwiZXhwIjoyMDc4NjY2MzQ0fQ.AuLJmmco5NR8d2Ueax9qNjPMWbdxIZenzOANqgJp0ww
      
      # Razorpay Configuration
      - RAZORPAY_KEY_ID=rzp_live_RWwON57KV1LaJn
      - RAZORPAY_KEY_SECRET=7AWWs351asukoB0uUHOViu7b
      - RAZORPAY_WEBHOOK_SECRET=gmb_boost_pro_webhook_secret_2024
      
      # Azure OpenAI Configuration
      - AZURE_OPENAI_ENDPOINT=https://agentplus.openai.azure.com/
      - AZURE_OPENAI_API_KEY=1TPW16ifwPJccSiQPSHq63nU7IcT6R9DrduIHBYwCm5jbUWiSbkLJQQJ99BDACYeBjFXJ3w3AAABACOG3Yia
      - AZURE_OPENAI_DEPLOYMENT=gpt-4o
      - AZURE_OPENAI_API_VERSION=2024-02-15-preview
      
      # Token Encryption Key (CRITICAL for OAuth tokens)
      - TOKEN_ENCRYPTION_KEY=gmb-boost-pro-2024-secure-encryption-key-change-this-in-production-32chars
      
      # Backend URL
      - BACKEND_URL=https://google-ranker-123-bjfkcffffyf0fagk.canadacentral-01.azurewebsites.net
      
      # Hybrid Mode - Multiple origins for CORS
      - ALLOWED_ORIGINS=https://happy-forest-0fe6bb90f.3.azurestaticapps.net,http://localhost:3000,http://localhost:5173
      
      # Email Service (Optional)
      - SENDGRID_API_KEY=
      
      # SMS Service (Optional)
      - TWILIO_ACCOUNT_SID=
      - TWILIO_AUTH_TOKEN=
      - TWILIO_PHONE_NUMBER=
    
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:5000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

networks:
  google-ranker-network-prod:
    driver: bridge

volumes:
  backend-logs:
    driver: local
  backend-data:
    driver: local
